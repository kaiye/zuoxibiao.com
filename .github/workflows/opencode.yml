name: OpenCode Agent

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  pull_request:
    types: [opened, synchronize, reopened]

# 防止并发运行，避免滥用
concurrency:
  group: opencode-${{ github.event.issue.number || github.event.pull_request.number }}
  cancel-in-progress: false

jobs:
  # 响应 issue/PR 中的 /oc 或 /opencode 命令
  opencode-comment:
    if: |
      (github.event_name == 'issue_comment' || github.event_name == 'pull_request_review_comment') &&
      (contains(github.event.comment.body, '/oc') || contains(github.event.comment.body, '/opencode'))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write
    steps:
      # 步骤 1: 检查用户权限（只允许仓库协作者）
      - name: Check user permissions
        id: check_permissions
        uses: actions/github-script@v7
        with:
          script: |
            const username = context.payload.comment.user.login;

            try {
              const { data: permission } = await github.rest.repos.getCollaboratorPermissionLevel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                username: username
              });

              // 只允许 write、maintain、admin 权限的用户
              const allowedPermissions = ['write', 'maintain', 'admin'];
              const hasPermission = allowedPermissions.includes(permission.permission);

              console.log(`User ${username} has permission: ${permission.permission}`);
              console.log(`Access allowed: ${hasPermission}`);

              if (!hasPermission) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: `⚠️ @${username} 你没有权限触发 OpenCode 命令。只有仓库协作者可以使用此功能。`
                });
              }

              return hasPermission;
            } catch (error) {
              console.log(`Permission check failed: ${error.message}`);
              return false;
            }

      # 步骤 2: 检出代码（仅当权限检查通过）
      - name: Checkout
        if: steps.check_permissions.outputs.result == 'true'
        uses: actions/checkout@v4

      # 步骤 2.5: 调试配置（仅当权限检查通过）
      - name: Debug OpenCode Configuration
        if: steps.check_permissions.outputs.result == 'true'
        run: |
          echo "=== OpenCode Configuration Debug ==="
          echo "Config file exists:"
          ls -la opencode.json || echo "opencode.json not found"
          echo ""
          echo "Config file content:"
          cat opencode.json || echo "Cannot read opencode.json"
          echo ""
          echo "Environment variables:"
          echo "ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:0:10}..."
          echo "ANTHROPIC_BASE_URL: '$ANTHROPIC_BASE_URL'"
          echo "ANTHROPIC_BASE_URL length: ${#ANTHROPIC_BASE_URL}"
          echo ""
          echo "Testing URL format:"
          echo "$ANTHROPIC_BASE_URL/v1/messages"
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ANTHROPIC_BASE_URL: ${{ vars.ANTHROPIC_BASE_URL }}

      # 步骤 3: 运行 OpenCode（仅当权限检查通过）
      - name: Run OpenCode
        if: steps.check_permissions.outputs.result == 'true'
        timeout-minutes: 10
        uses: anomalyco/opencode/github@latest
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ANTHROPIC_BASE_URL: ${{ vars.ANTHROPIC_BASE_URL }}
          OPENCODE_CONFIG_CONTENT: |
            {
              "provider": {
                "custom": {
                  "options": {
                    "apiKey": "{env:ANTHROPIC_API_KEY}",
                    "baseURL": "{env:ANTHROPIC_BASE_URL}",
                    "timeout": 30000
                  }
                }
              },
              "agent": {
                "build": {
                  "permission": {
                    "question": "deny",
                    "read": "allow",
                    "edit": "allow",
                    "write": "allow",
                    "bash": "allow",
                    "glob": "allow",
                    "grep": "allow",
                    "task": "allow",
                    "todowrite": "allow",
                    "todoread": "allow",
                    "webfetch": "allow",
                    "doom_loop": "allow"
                  },
                  "steps": 20
                }
              }
            }
        with:
          model: anthropic/claude-sonnet-4-5-20250929

  # 自动审查新开的 PR（只审查协作者的 PR）
  opencode-pr-review:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write
    steps:
      # 检查 PR 作者权限
      - name: Check PR author permissions
        id: check_author
        uses: actions/github-script@v7
        with:
          script: |
            const username = context.payload.pull_request.user.login;

            try {
              const { data: permission } = await github.rest.repos.getCollaboratorPermissionLevel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                username: username
              });

              const allowedPermissions = ['write', 'maintain', 'admin'];
              const hasPermission = allowedPermissions.includes(permission.permission);

              console.log(`PR author ${username} has permission: ${permission.permission}`);
              return hasPermission;
            } catch (error) {
              console.log(`Permission check failed: ${error.message}`);
              return false;
            }

      - name: Checkout
        if: steps.check_author.outputs.result == 'true'
        uses: actions/checkout@v4

      - name: Review PR with OpenCode
        if: steps.check_author.outputs.result == 'true'
        timeout-minutes: 10
        uses: anomalyco/opencode/github@latest
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ANTHROPIC_BASE_URL: ${{ vars.ANTHROPIC_BASE_URL }}
          OPENCODE_CONFIG_CONTENT: |
            {
              "provider": {
                "custom": {
                  "options": {
                    "apiKey": "{env:ANTHROPIC_API_KEY}",
                    "baseURL": "{env:ANTHROPIC_BASE_URL}",
                    "timeout": 30000
                  }
                }
              },
              "agent": {
                "build": {
                  "permission": {
                    "question": "deny",
                    "read": "allow",
                    "edit": "allow",
                    "write": "allow",
                    "bash": "allow",
                    "glob": "allow",
                    "grep": "allow",
                    "task": "allow",
                    "todowrite": "allow",
                    "todoread": "allow",
                    "webfetch": "allow",
                    "doom_loop": "allow"
                  },
                  "steps": 20
                }
              }
            }
        with:
          model: anthropic/claude-sonnet-4-5-20250929
          prompt: |
            Review this pull request:
            - Check code quality and TypeScript best practices
            - Look for potential bugs or issues
            - Verify the changes align with the project structure
            - Suggest improvements if needed
            Be concise and helpful. Reply in Chinese.
